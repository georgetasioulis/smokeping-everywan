version: '3.8'

services:
  smokeping:
    image: sistemasminorisa/smokeping:2.9.0
    hostname: ${SMOKEPING_HOSTNAME:-smokeping-master}
    environment:
      # --- System Configuration ---
      # User ID for the smokeping process. Defaults to 1000.
      - PUID=${PUID:-1000}
      # Group ID for the smokeping process. Defaults to 1000.
      - PGID=${PGID:-1000}
      # Timezone for the container. Defaults to Europe/Madrid.
      - TZ=${TZ:-Europe/Madrid}
      
      # --- Alerts (Telegram) ---
      # Telegram Bot Token for sending alerts. Leave empty to disable.
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      # Telegram Chat ID to send alerts to. Leave empty to disable.
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
      
      # --- Site Identity ---
      # Name of the owner displayed in the web interface. Defaults to 'SmokePing Admin'.
      - SMOKEPING_OWNER=${SMOKEPING_OWNER:-SmokePing Admin}
      # Contact email displayed in the web interface. Defaults to 'admin@example.com'.
      - SMOKEPING_CONTACT=${SMOKEPING_CONTACT:-admin@example.com}
      # Hostname used for internal configuration and display. Defaults to 'smokeping-master'.
      - SMOKEPING_HOSTNAME=${SMOKEPING_HOSTNAME:-smokeping-master}
      # Title displayed in the web interface. Defaults to 'Network Monitor'.
      - SMOKEPING_TITLE=${SMOKEPING_TITLE:-Network Monitor}
      
      # --- Branding ---
      # Brand name displayed in the web interface. Defaults to 'My Company'.
      - SMOKEPING_BRAND_NAME=${SMOKEPING_BRAND_NAME:-My Company}
      # URL for the brand name link. Defaults to 'https://example.com'.
      - SMOKEPING_BRAND_URL=${SMOKEPING_BRAND_URL:-https://example.com}
      # URL for the logo image. Defaults to 'https://example.com/logo.png'.
      - SMOKEPING_LOGO_URL=${SMOKEPING_LOGO_URL:-https://example.com/logo.png}
      # Background color for the sidebar. Defaults to '#1a1a2e'.
      - SMOKEPING_COLOR_SIDEBAR_BG=${SMOKEPING_COLOR_SIDEBAR_BG:-#1a1a2e}
      
      # --- Traceroute Config ---
      # Interval in seconds between traceroute pings. Defaults to 300 (5 minutes).
      - TRACEPING_INTERVAL=${TRACEPING_INTERVAL:-300}
      # Number of days to retain traceroute data. Defaults to 365.
      - TRACEPING_RETENTION_DAYS=${TRACEPING_RETENTION_DAYS:-365}
      - TRACEPING_ASN_LOOKUP=${TRACEPING_ASN_LOOKUP:-false}
      
    cap_add:
      - NET_RAW
      - NET_ADMIN
      
    volumes:
      - /mnt/ceph/swarm/smokeping/config:/config
      - /mnt/ceph/swarm/smokeping/data:/data
      - /mnt/ceph/swarm/smokeping/logs:/logs
      
    networks:
      - traefik-public
      
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        - "traefik.enable=true"
        # Router for Port 80
        - "traefik.http.routers.smokeping.rule=Host(`smokeping.example.com`)"
        - "traefik.http.routers.smokeping.entrypoints=websecure"
        - "traefik.http.routers.smokeping.tls=true"
        - "traefik.http.routers.smokeping.tls.certresolver=leresolver"
        - "traefik.http.routers.smokeping.service=smokeping-svc"
        - "traefik.http.services.smokeping-svc.loadbalancer.server.port=80"
        # Middleware for slash redirect
        - "traefik.http.middlewares.smokeping-slash.redirectregex.regex=^https?://([^/]+)/smokeping$$"
        - "traefik.http.middlewares.smokeping-slash.redirectregex.replacement=https://$${1}/smokeping/"
        - "traefik.http.routers.smokeping.middlewares=smokeping-slash"

networks:
  traefik-public:
    external: true

# SmokePing Docker - Traefik + Swarm Deployment
# No requiere nginx - Traefik maneja el routing directamente
#
# Uso:
#   docker stack deploy -c docker-compose.swarm.yml smokeping

version: '3.8'

services:
  smokeping:
    image: sistemasminorisa/smokeping:2.9.0
    hostname: ${SMOKEPING_HOSTNAME:-smokeping-master}
    environment:
      # --- System ---
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/Madrid}
      
      # --- Site Identity ---
      - SMOKEPING_OWNER=${SMOKEPING_OWNER:-SmokePing Admin}
      - SMOKEPING_CONTACT=${SMOKEPING_CONTACT:-admin@example.com}
      - SMOKEPING_HOSTNAME=${SMOKEPING_HOSTNAME:-smokeping-master}
      - SMOKEPING_TITLE=${SMOKEPING_TITLE:-Network Monitor}
      
      # --- Branding ---
      - SMOKEPING_BRAND_NAME=${SMOKEPING_BRAND_NAME:-}
      - SMOKEPING_BRAND_URL=${SMOKEPING_BRAND_URL:-}
      - SMOKEPING_LOGO_URL=${SMOKEPING_LOGO_URL:-images/smokeping.png}
      
      # --- Theme & Colors (Defaults to Blue Theme) ---
      - SMOKEPING_COLOR_PRIMARY=${SMOKEPING_COLOR_PRIMARY:-#007bff}
      - SMOKEPING_COLOR_SECONDARY=${SMOKEPING_COLOR_SECONDARY:-#6c757d}
      - SMOKEPING_COLOR_ACCENT=${SMOKEPING_COLOR_ACCENT:-#00d4ff}
      - SMOKEPING_COLOR_SIDEBAR_BG=${SMOKEPING_COLOR_SIDEBAR_BG:-#1a1a2e}
      - SMOKEPING_COLOR_SIDEBAR_TEXT=${SMOKEPING_COLOR_SIDEBAR_TEXT:-rgba(255,255,255,0.8)}
      - SMOKEPING_COLOR_HEADER_BG=${SMOKEPING_COLOR_HEADER_BG:-#16213e}
      - SMOKEPING_FONT_FAMILY=${SMOKEPING_FONT_FAMILY:-Poppins, sans-serif}
      - SMOKEPING_FONT_URL=${SMOKEPING_FONT_URL:-https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700}
      
      # --- Traceroute ---
      - TRACEPING_INTERVAL=${TRACEPING_INTERVAL:-300}
      - TRACEPING_RETENTION_DAYS=${TRACEPING_RETENTION_DAYS:-365}
      - TRACEPING_PORT=${TRACEPING_PORT:-9000}
    
    # Capabilities for ping/traceroute
    cap_add:
      - NET_RAW
      - NET_ADMIN
    
    volumes:
      # Ajusta estas rutas a tu entorno
      - ${SMOKEPING_CONFIG_PATH:-./config}:/config
      - ${SMOKEPING_DATA_PATH:-./data}:/data
      - ${SMOKEPING_LOGS_PATH:-./logs}:/logs
    
    networks:
      - traefik-public

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        - "traefik.enable=true"
        
        # ============================================
        # Router 1: Web Interface (Port 80)
        # ============================================
        # Todas las peticiones EXCEPTO traceping.cgi
        - "traefik.http.routers.smokeping-web.rule=Host(`${SMOKEPING_DOMAIN:-smokeping.example.com}`) && !Path(`/smokeping/traceping.cgi`)"
        - "traefik.http.routers.smokeping-web.entrypoints=websecure"
        - "traefik.http.routers.smokeping-web.tls=true"
        - "traefik.http.routers.smokeping-web.tls.certresolver=${TRAEFIK_CERT_RESOLVER:-leresolver}"
        - "traefik.http.routers.smokeping-web.service=smokeping-web-svc"
        - "traefik.http.services.smokeping-web-svc.loadbalancer.server.port=80"
        
        # Middleware: Redirect /smokeping to /smokeping/
        - "traefik.http.middlewares.smokeping-slash.redirectregex.regex=^https?://([^/]+)/smokeping$$"
        - "traefik.http.middlewares.smokeping-slash.redirectregex.replacement=https://$${1}/smokeping/"
        - "traefik.http.routers.smokeping-web.middlewares=smokeping-slash"

        # ============================================
        # Router 2: Traceroute API (Port 9000)
        # ============================================
        # Solo peticiones a traceping.cgi -> servidor Perl en puerto 9000
        - "traefik.http.routers.smokeping-trace.rule=Host(`${SMOKEPING_DOMAIN:-smokeping.example.com}`) && Path(`/smokeping/traceping.cgi`)"
        - "traefik.http.routers.smokeping-trace.entrypoints=websecure"
        - "traefik.http.routers.smokeping-trace.tls=true"
        - "traefik.http.routers.smokeping-trace.tls.certresolver=${TRAEFIK_CERT_RESOLVER:-leresolver}"
        - "traefik.http.routers.smokeping-trace.service=smokeping-trace-svc"
        - "traefik.http.services.smokeping-trace-svc.loadbalancer.server.port=9000"

networks:
  traefik-public:
    external: true
